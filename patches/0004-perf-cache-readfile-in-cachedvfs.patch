From 9e66e57ab35a2aa9a0d4ad28b006a9df61b7931a Mon Sep 17 00:00:00 2001
From: Codex <codex@example.com>
Date: Thu, 12 Feb 2026 13:55:47 +0900
Subject: [PATCH 7/7] perf(vfs): cache ReadFile results in cachedvfs

---
 internal/vfs/cachedvfs/cachedvfs.go | 24 +++++++++++++++++++++++-
 1 file changed, 23 insertions(+), 1 deletion(-)

diff --git a/internal/vfs/cachedvfs/cachedvfs.go b/internal/vfs/cachedvfs/cachedvfs.go
index 13ec842f72..c880479ef6 100644
--- a/internal/vfs/cachedvfs/cachedvfs.go
+++ b/internal/vfs/cachedvfs/cachedvfs.go
@@ -15,10 +15,16 @@ type FS struct {
 	directoryExistsCache      collections.SyncMap[string, bool]
 	fileExistsCache           collections.SyncMap[string, bool]
 	getAccessibleEntriesCache collections.SyncMap[string, vfs.Entries]
+	readFileCache             collections.SyncMap[string, readFileCacheEntry]
 	realpathCache             collections.SyncMap[string, string]
 	statCache                 collections.SyncMap[string, vfs.FileInfo]
 }
 
+type readFileCacheEntry struct {
+	contents string
+	ok       bool
+}
+
 var _ vfs.FS = (*FS)(nil)
 
 func From(fs vfs.FS) *FS {
@@ -41,6 +47,7 @@ func (fsys *FS) ClearCache() {
 	fsys.directoryExistsCache.Clear()
 	fsys.fileExistsCache.Clear()
 	fsys.getAccessibleEntriesCache.Clear()
+	fsys.readFileCache.Clear()
 	fsys.realpathCache.Clear()
 	fsys.statCache.Clear()
 }
@@ -94,7 +101,22 @@ func (fsys *FS) GetAccessibleEntries(path string) vfs.Entries {
 }
 
 func (fsys *FS) ReadFile(path string) (contents string, ok bool) {
-	return fsys.fs.ReadFile(path)
+	if fsys.enabled.Load() {
+		if ret, hit := fsys.readFileCache.Load(path); hit {
+			return ret.contents, ret.ok
+		}
+	}
+
+	contents, ok = fsys.fs.ReadFile(path)
+
+	if fsys.enabled.Load() {
+		fsys.readFileCache.Store(path, readFileCacheEntry{
+			contents: contents,
+			ok:       ok,
+		})
+	}
+
+	return contents, ok
 }
 
 func (fsys *FS) Realpath(path string) string {
-- 
2.50.1 (Apple Git-155)


name: Benchmark

on:
  pull_request:
    branches: [main]

permissions:
  pull-requests: write
  contents: read

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26"

      - name: Setup Just
        uses: extractions/setup-just@v2

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"
          cache-dependency-path: "pnpm-lock.yaml"

      - name: Init submodule
        run: just init

      - name: Install benchmark deps
        run: cd benchmarks && pnpm install --frozen-lockfile

      # ── PR benchmarks ──
      - name: Build PR binary
        run: just build

      - name: Build PR companions
        run: cd benchmarks && pnpm run build

      - name: Run PR benchmarks
        run: cd benchmarks && npx tsx --tsconfig bench/tsconfig.json bench/bench-all.ts --json > /tmp/pr-bench.json

      # ── Base benchmarks ──
      - name: Checkout base
        run: git checkout ${{ github.event.pull_request.base.sha }}

      - name: Rebuild for base
        id: base-build
        continue-on-error: true
        run: |
          just init
          just build
          cd benchmarks && pnpm run build

      - name: Run base benchmarks
        id: base-bench
        if: steps.base-build.outcome == 'success'
        continue-on-error: true
        run: cd benchmarks && npx tsx --tsconfig bench/tsconfig.json bench/bench-all.ts --json > /tmp/base-bench.json

      # ── Comparison ──
      - name: Checkout PR (for comparison script)
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Generate comparison
        if: steps.base-bench.outcome == 'success'
        run: node .github/scripts/compare-benchmarks.js /tmp/base-bench.json /tmp/pr-bench.json > /tmp/bench-comment.md

      - name: Generate PR-only report
        if: steps.base-bench.outcome != 'success'
        run: |
          echo "## Benchmark Results (PR only)" > /tmp/bench-comment.md
          echo "" >> /tmp/bench-comment.md
          echo "Base benchmark could not be run (build or runtime error on base branch)." >> /tmp/bench-comment.md
          echo "Showing PR benchmark results only:" >> /tmp/bench-comment.md
          echo "" >> /tmp/bench-comment.md
          echo '```json' >> /tmp/bench-comment.md
          cat /tmp/pr-bench.json >> /tmp/bench-comment.md
          echo '```' >> /tmp/bench-comment.md

      - name: Post benchmark comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: benchmark
          path: /tmp/bench-comment.md
